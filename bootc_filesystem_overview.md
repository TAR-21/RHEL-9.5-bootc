# bootc のファイルのしくみをざっくり説明

## bootc は「OSをコンテナのように管理・更新できる」しくみです。  
そのため、ファイルの置き場所や振る舞いに特別なルールがあります。

### コンテナとして動作しているとき（ビルド中）

普通のコンテナと同じように、全てのファイルに書き込み可能です。  
例えば `/usr/bin` にアプリを入れたり、設定ファイルを追加するのもOKです。

### 実際にデバイスにインストールして起動すると？

イメージを物理マシンや仮想マシンに「インストール」すると、システムは以下のようになります：

**/usr**  
OSの本体（プログラムやライブラリ）。読み取り専用です。

**/etc**  
設定ファイルを格納します。デフォルトでは書き換え可能で、アップデートしても変更内容が保持されます。

**/var**  
ログやデータベースなど、実行中に生成されるデータが保存されます。書き換え可能で、永続的に保持されます。

**/opt**  
一部のソフトウェアが使う場所です。通常は読み取り専用ですが、設定によって書き込み可能にすることもできます。

### こうした振る舞いはどこで設定するの？

ファイルシステムの挙動（読み取り専用にするか、一時的に書き込みを許可するかなど）は、次の設定ファイルで制御されます。

```
/usr/lib/ostree/prepare-root.conf
```

このファイルに書かれた内容が、起動時に反映されます。

### よく使う設定例

```
[composefs]
enabled = true
```
ファイルシステム全体を読み取り専用にします（標準的な設定です）

```
[root]
transient = true
```
/opt や /usr に一時的に書き込みを許可します。再起動すると変更は元に戻ります。

```
[etc]
transient = true
```
/etc の内容も一時的にします。設定ファイルを都度リセットしたい場合に使用します。

### 注意点

- /var のデータは、初回の展開時にのみイメージから展開されます。以降は独立したデータとして保持され、bootc のアップグレードやロールバックでは変更されません。
- /opt にインストールする必要があるソフトウェアは、読み取り専用の制約に注意が必要です。対策として、「ostree-state-overlay」サービスや `/var` へのシンボリックリンクが利用できます。
- SELinux を利用している環境では、新しいトップレベルディレクトリ（例: /app）に適切なラベルを付けないとアクセスできないことがあります。

### まとめ

| フォルダ | 内容 | 書き換え可能か | 備考 |
|---------|------|----------------|------|
| /usr    | OSの中身 | 基本は不可 | transient を使えば一時的に書き込み可能 |
| /etc    | 設定ファイル | 書き換え可能 | 状態を残す／リセットするを選べる |
| /var    | 実行データやログ | 書き換え可能 | アップデートの影響を受けない |
| /opt    | アプリ用ファイル | 通常は不可 | オーバーレイやリンクで書き込み可能にできる |

このように bootc では、OSの構成を守りつつ柔軟にカスタマイズできるように設計されています。  
目的に応じて適切にファイルシステムの挙動を制御することで、安全性と運用性を両立できます。
