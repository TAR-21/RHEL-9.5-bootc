# OSTreeベースシステムにおけるアプリ展開の対応ガイド

OSTree（例: Red Hat Enterprise Linux for Edge の基盤技術）は、OSの**不変性 (Immutable OS)** を核とする技術です。`/usr` ディレクトリなどのシステムの中核部分がリードオンリーであるため、アプリケーションやユーザーデータ、ログなどは、書き込みが許可された領域に配置・保存する必要があります。

## 1. リードオンリーであることの理解とメリット

* **対象**: 主に `/usr` ディレクトリ（OSのバイナリ、ライブラリ、システムファイルなど）が読み取り専用です。
* **メリット**:
    * **一貫性**: すべてのデバイスが同じ「ゴールデンイメージ」で動作し、構成のドリフトを防ぎます。
    * **信頼性**: 不正な変更やマルウェアからの保護が強化されます。
    * **アトミックな更新とロールバック**: OS全体の更新が失敗した場合でも、確実に以前の安定した状態に戻すことができます。

## 2. アプリケーションとデータの書き込み可能な領域の活用

アプリケーションやユーザーデータ、ログなどは、以下の書き込み可能なディレクトリに配置・保存します。

* **`/var` ディレクトリ**:
    * **用途**: **最も重要な書き込み可能な領域**です。可変データ、ログファイル、一時ファイル、ランタイムデータ、コンテナストレージなどが含まれます。
    * **例**: コンテナのルートファイルシステム（`/var/lib/containers`）、アプリケーションのデータ、ログファイル（`/var/log`）。

* **`/etc` ディレクトリ**:
    * **用途**: システム全体の設定ファイルが格納されます。OSTreeでは設定のオーバーレイとして扱われ、OSイメージの更新後も変更が保持されます。
    * **注意点**: 設定管理ツール（例: Ansible）を使った自動化とバージョン管理がベストプラクティスです。

* **`/home` ディレクトリ**:
    * **用途**: ユーザーのホームディレクトリ。ユーザー固有の設定やデータが保存されます。

* **`/opt` ディレクトリ (推奨度は低い)**:
    * **用途**: サードパーティ製ソフトウェアの伝統的なインストール場所。
    * **注意点**: OSTree環境では**コンテナ化が強く推奨**されるため、極力避けるべきです。

## 3. コンテナ化の徹底 (最も重要)

リードオンリーOS環境でアプリケーションを実行するための最も効果的な解決策は**コンテナ化**です。

* **理由**: コンテナは独自の書き込み可能なレイヤーを持ち、ホストOSの読み取り専用部分から完全に分離されます。
* **メリット**:
    * OSの不変性を保ちながら、アプリケーションの自由なデプロイ・更新が可能。
    * アプリケーションの依存関係がコンテナ内に閉じ込められ、ホストOSに影響を与えない。
    * アプリケーションのライフサイクル管理（デプロイ、更新、ロールバック）が容易。
* **実装**: Podman (シングルデバイス向け) や MicroShift/Kubernetes (複数コンテナ/複数デバイス向け) を活用します。

## 4. 永続ストレージの設計

アプリケーションが生成するデータや、再起動後も保持したいデータがある場合、永続ストレージを確保します。

* **Kubernetes (MicroShift) の場合**: Persistent Volume (PV) / Persistent Volume Claim (PVC) や Host Path Volume を使用し、ホストOS上の `/var` などの書き込み可能なディレクトリにデータを永続化します。
* **Podman の場合**: ボリュームマウント (`podman run -v /host/path:/container/path ...`) を使用します。

## 5. 構成管理の自動化

* `/etc` などホストOSの設定を変更する必要がある場合は、Ansibleなどの構成管理ツールを使用して**宣言的に設定を適用・管理**します。これにより、一貫した設定を維持し、ドリフトを防ぎます。

## まとめ

OSTreeベースのシステムでリードオンリー部分に対応する主要な戦略は、**アプリケーションの徹底的なコンテナ化**と、OSが提供する`/var` や `/etc` といった**書き込み可能な標準ディレクトリの適切な活用**です。これにより、OSの堅牢性とアプリケーションの柔軟性を両立させることができます。
